version: "3.8"

services:
  # 反向代理：负责分发流量
  caddy:
    image: caddy:2
    container_name: novel_caddy
    restart: unless-stopped
    ports:
      - "8080:80"
      - "8443:443"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./caddy/logs:/var/log/caddy
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - web
      - api

  # 数据库：存储所有结构化数据
  db:
    image: postgres:15
    container_name: novel_db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./db/init:/docker-entrypoint-initdb.d # 自动执行 SQL 脚本
    ports:
      - "8432:5432"

  # 缓存：处理实时写作状态同步
  redis:
    image: redis:7
    container_name: novel_redis
    restart: unless-stopped
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD}"]
    volumes:
      - redisdata:/data

  # 对象存储：存储头像、插图、导出的文件
  minio:
    image: minio/minio:latest
    container_name: novel_minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    volumes:
      - miniodata:/data
    ports:
      - "9000:9000"
      - "9001:9001"

  # 搜索引擎：全文检索小说内容
  meilisearch:
    image: getmeili/meilisearch:v1.2
    container_name: novel_meili
    restart: unless-stopped
    environment:
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY}
    volumes:
      - meili_data:/data.ms
    ports:
      - "7700:7700"

  # 后端 API (占位服务，暂不构建)
  api:
    #image: node:20-slim
    image: node:20
    container_name: novel_api
    #command: tail -f /dev/null
    command: npm run start:dev 
    working_dir: /app
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
    volumes:
      - ./api:/app  # <--- 新增这一行：将本地 api 目录挂载到容器内

  # 前端 Web (占位服务，暂不构建)
  web:
    #image: node:20-slim
    image: node:20
    container_name: novel_web
    command: npm run dev -- -H 0.0.0.0
    #command: tail -f /dev/null
    working_dir: /app
    volumes:
      - ./web:/app  # <--- 新增这一行：将本地 web 目录挂载到容器内
    ports:
      - "3800:3000"

volumes:
  pgdata:
  redisdata:
  miniodata:
  meili_data:
  caddy_data:
  caddy_config:
